**Название задачи:** ADR-MVP-1 Банк Стандарт  
**Автор:** Аксёнов Иван    
**Дата:** 14.12.2024

**Функциональные требования**

| №   | Действующие лица или системы                          | Use Case             | Описание                                                                                                                                                                                                                                                                                                                                                                                                                          |
|-----|-------------------------------------------------------|----------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| UC1 | Клиент, <br/>Сайт, <br/>Кол-центр                     | Новый клиент с сайта | 1. Клиент переходит на сайт и видит список депозитов со ставками.  <br/>2. Клиент нажимает кнопку оформить заявку вводя номер телефона и ФИО в поля формы.<br/> 3. Заявка отправляется в систему кол-центра для звонка менеджера                                                                                                                                                                                                  |
| UC2 | Клиент, <br/>Менеджер фронт-офиса, <br/>Интернет-банк | Регистрация          | 1. После звонка менеджера, клиент приходит в отделение.<br/>2. Менеджер проверяет документы и создает для клиента личный кабинет в интернет-банке<br/> 3. Клиенту приходит СМС с временным паролем для вхоа в интернет-банк<br/>4. Клиент входит в интернет-банк с временным паролем и меняет его на свой.                                                                                                                        |
| UC3 | Клиент, <br/>интернет-банк, <br/>СМС-шлюз             | Оформление заявки    | 1. Клиент входит в интернет-банк используя логин-пароль.<br/>2. Клиент переходит в раздел депозитов и видит список доступных депозитов с актуальными ставками, а также персонифицированные ставки для него<br/>4. Клиент выбирает счет и указывает сумму депозита, нажимает кнопку открыть.<br/> 5. В подтверждение операции открытия приходит СМС, код из которой кдиент вводит в соответствующем поле формы интернет-банка<br/> |
| UC4 | Менеджер бэк-офиса, <br/>АБС, <br/>СМС-шлюз           | Открытие депозита    | 1. Менеджер в системе отрывает заявку на открытие депозита<br/>2. Подтверждает условия открытия депозита и открывает соответствующий счет в АБС банка.<br/> 3. После успешного открытия депозита, клиенту приходит СМС с подтверждением ставки и деталями открытого депозита.                                                                                                                                                     |

**Нефункциональные требования**

| №   | Требование                                                                                                                       |
|-----|:---------------------------------------------------------------------------------------------------------------------------------|
| R1  | Все сервисы должны работать 24/7                                                                                                 |
| R2  | Уровень доступности платформы должен соотвествовать SLA 99.9%                                                                    |
| P2  | Отклик по всем операциям должен быть максимально быстрым и занимать миллисекунды                                                 |
| +R1 | Для доступа к сайту и интернет-банку исплоьзовать шифрованый протокол (HTTPS)                                                    |
| +R4 | Используем микросервисную архитектуру с развертыванием в Kubernetes для обеспечения более гибкой маштабируемости и развертывания |
| +R5 | Команда АБС утверждает, что база данных системы уже перегружена                                                                  |
| +R8 | Реализовать платформу на основе Event Driven похода, для будущих перспектив.                                                     |
| +R9 | Платформа должна удовлетворять всем требованиям местных регуляторов по защите, хранению и обработке персональной информации      |

**Решение**

Диаграмма контекста.

```puml
@startuml
scale 0.85
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
SHOW_PERSON_OUTLINE()

title Банк Стандарт MVP Context Diagram
top to bottom direction
'skinparam linetype ortho
'skinparam linetype polyline

Person(client, "Клиент банка", "")

System_Ext(telecom, "Телеком оператор", "Рассылает СМС-уведомления")

Boundary(system, "Банк Стандарт") {
    Boundary(frontOffice, "Банк Стандарт фронт-офис") {
        Person(frontManager, "Менеджер фронт офиса", "Менеджер отделения банка")
    }
    
    Boundary(backOffice, "Банк Стандарт бэк-офис") {
        System(bank, "IT банка", "Обеспечивает операционную деятельность банка. Включает не только АБС, но все IT компоненты")
        System(callCenter, "Кол-центр", "Обрабатывает входящие звонки")
        System(smsGateway, "СМС-шлюз", "Рассылает СМС-уведомления")
    
        Person(backManager, "Менеджер бэк-офиса", "Обрабатывает заявки")
    }
    
    
}

client-down->bank: "Использует сайт или интернет-банк"
callCenter<-->client: "Работает с клиентами"
callCenter-->bank: "Формирует заявки"
frontManager<--client: ""
frontManager-->bank: "Работает с АБС"
backManager-->bank: "Обрабатывает заявки"
telecom-->client: "Отправляет смс-уведомления"
smsGateway-->telecom: "Отправляет смс-уведомления"
bank-->smsGateway: "Формирует смс-уведомления"



'SHOW_LEGEND()
@enduml
```

Для решения задачи онлайн открытия депозитов, потребуется доработка как существующих систем, так разработка и внедрение
новых компонентов.  
В диаграмме контекста под "Банковским ПО" подразумевается совокупность программных комплексов банка, обеспечивающих как
текущую
операционную деятельность банка, так и новых компонент, решающих задачи MVP. Детализация конкретных компонент и их
взаимодействий
в рамках MVP представлена ниже на диаграмме контейнеров.

Для того чтобы клиент мог определиться с открытием депозита, необходимо предоставить ему в интернет-банке ставки которые
предлагает
банк. Сейчас ставка депозита просчитывается вручную сотрудником кредитного подразделения.
Поэтому в момент перехода в раздел депозитов в интернет-банке, ставки уже должны быть доступны. Ставки обновляются
ежедневно.
Решением будет разработка отдельного сервиса `Rates Service`, для работы со ставками как депозитными, там и кредитными.
Данный сервис раз в сутки (например ночью или даже чаще), используя паттерн Polling publisher, будет обращаться к АБС,
выгружая данные, необходимые для расчет ставок. С началом
операционного дня, сотрудник кредитного отдела заходит в систему, проделывает дополнительные расчеты (если необходимо) и
подтверждает рассчитанные ставки.
После этого они сохраняются в БД сервиса и, потенциально, публикуются.

Проблема банковского ПО в том, что вся операционно-значимая информация хранится в АБС, которая уже перегружена.
Одним из требований было избегать прямого доступа из интернет-банка в рамках нового процесса.
Используя сервис `Rates Service` мы сможем не нагружать АБС лишними запросами и при этом предоставить возможность
получать актуальные ставки всем заинтересованным потребителям,
минуя прямое обращение к АБС.

Следующий момент с заявками. Сейчас заявки создаются в АБС, и потом сотрудник бэк-офиса обрабатывает их из АБС.
Создадим отдельный сервис по обработке заявок `Requests Service`, в который заявки будут попадать из систем кол-центра и
интернет-банка. Обе системы
имеют возможности для доработки, в отличие от АБС, что потенциально позволяет использовать Event Driven поход для
публикации событий заявок.
В рамках MVP можно оставить обработку заявок в АБС, но наща цель через год исключить из процесса оформления заявки
сотрудника бэк-офиса, поэтому
на текущем этапе будем готовить систему к этому переходу, несмотря на то, что пока останется ручная обработка.

Процесс открытия депозита онлайн видится следующим образом:

- После регистрации клиента, он входит в свой интернет-банк с логином-паролем.
- Переходит в раздел депозитов
- Интернет-банк обращается к сервису `Rates Service` за информацией
- Сервис `Rates Service` возвращает данные по депозитам, общие банковские ставки и персонифицированные.
- Клиент формирует заявку заполняя форму.
- Интернет-банк формирует событие об создании новой заявки в Event Bus
- `Requests Service` получает событие о новой заявке по подписке и сохраняет её.
- Сервис `Requests Service` отправляет событие на формирование подтверждения через СМС-код
- Клиент в интернет-банке подтверждает открытие заявки вводом кода из СМС и отправляет данную информацию в сервис
  `Requests Service`.
- Сотрудник бэк-офиса открывает заявки из сервиса `Requests Service`, верифицирует её и подтверждает.
- При подтверждении сотрудник бэк-офиса создает необходимые артефакты в АБС банка.
- После создания счета и депозита в БД, АБС отправляет клиенту СМС-уведомление об успешном открытии депозита с деталями.

```puml
@startuml
scale 0.8
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
SHOW_PERSON_OUTLINE()

title Банк Стандарт MVP Container Diagram
top to bottom direction
'skinparam linetype ortho
'skinparam linetype polyline

!pragma layout smetana

AddElementTag("mvp", $shape=RoundedBoxShape(), $bgColor="CornflowerBlue", $fontColor="white", $legendText="microservice")
AddElementTag("storage", $shape=RoundedBoxShape(), $bgColor="lightSkyBlue", $fontColor="white", $legendText="storage")
AddElementTag("queue", $shape=RoundedBoxShape(), $bgColor="#b6ccde", $fontColor="white", $legendText="event sourcing")
AddRelTag("async", $textColor=$ARROW_FONT_COLOR, $lineColor=$ARROW_COLOR, $lineStyle=DashedLine())

Person(client, "Клиент банка", "")

System_Ext(telecom, "Телеком оператор", "Рассылает СМС-уведомления")

Boundary(system, "Банк Стандарт") {
    Boundary(frontOffice, "Банк Стандарт фронт-офис") {
        Person(frontManager, "Менеджер фронт офиса", "Менеджер отделения банка")
    }
    
    Boundary(backOffice, "Банк Стандарт бэк-офис") {
        Container(abs, "АБС банка", "Delphi", "Клиент для операционной деятельности сотрудников банка" )
        ContainerDb(abs_db, "База данных АБС", "Oracle/ PL-SQL", "Информацию о клиентах\nСчета и операции\nУправленческая информация\nСистемы управления рисками\nМногое другое", $tags = "storage")
        
        Container(internetBank, "Интернет-банк", "ASP.NET MVC 4.5", "Интернет-банк. Монолитная архитектура" )
        'ContainerDb(internetBank_db, "База данных интернет-банка", "MS SQL", "Данные интернет-банка", $tags = "storage")
        
        Container(ratesService, "Сервис депозитов и ставок", "SpringBoot", "Формирует ставки по депозитам\nПросчитывает персональные ставки", $tags = "mvp")
        ContainerDb(ratesService_db, "База данных сервиса ставок", "PostgreSQL", "Хранит данные по актуальным ставкам\nХранит информацию для расчет ставок", $tags = "storage")
        Container(requestsService, "Сервис заявок", "SpringBoot", "Работа с заявками на депозит", $tags = "mvp")
        ContainerDb(requestsService_db, "База данных сервиса заявок", "PostgreSQL", "Хранит заявки на депозит и метаинформацию", $tags = "storage")
        
        ContainerQueue(kafka, "Kafka", "kafka", "Получает и публикует события", "Uses kafka protocol", $tags = "queue")
        
        Container(site, "Сайт", "PHP / React.js", "Сайт банка" )
        
        Container(callCenter, "Кол-центр", "Обрабатывает входящие звонки")
        
        Container(smsGateway, "СМС-шлюз", "Рассылает СМС-уведомления")
    
        Person(backManager, "Менеджер бэк-офиса", "Обрабатывает заявки")
    }
    
}
Rel(client, frontManager, "Регистрация нового клиента")
Rel(frontManager, abs, "Регистрация нового клиента")

Rel(client, site, "Заявка на депозит", "HTTP/HTML")
Rel(site, callCenter, "Заявка на депозит", "HTTP/Rest")
Rel(callCenter, "kafka", "Событие формирования новой заявки", "kafka", $tags = "async" )

Rel(client, internetBank, "Раздел депозитов", "HTTP/HTML")
Rel(internetBank, ratesService, "Запрашивает депозиты и ставки", "HTTP/Rest")
Rel(ratesService, ratesService_db, "Читает/сохраняет данные", "SQL")
Rel(internetBank, kafka, "Событие формирования новой заявки", "kafka", $tags = "async")
Rel_Neighbor(kafka, requestsService, "Подписан на события по новым заявкам", "kafka", $tags = "async")
Rel(requestsService, requestsService_db, "Сохраняет заявку", "SQL")
Rel(requestsService, smsGateway, "Отправляет код подтверждения")
Rel(smsGateway, telecom, "СМС подтверждения")
Rel(backManager, requestsService, "Обрабатывает новую заявку", "HTTP/HTML")
Rel(backManager, abs, "Открытие счета и депозита", "SQL")
Rel(backManager, ratesService, "Расчет ставок депозитов", "HTTP/Rest")
Rel(abs, abs_db, "Сохранение данных", "SQL/PL_SQL")
Rel(abs, smsGateway, "СМС подтверждения", "SMS")

Rel(ratesService, abs, "Опрос данных для расчет ставок", "SQL")


@enduml
```

**Альтернативы**

Одним из альтернативных вариантов решения можно рассмотреть использование паттерна `Transaction log tailing` базы данных
АБС, с последующей публикацией
событий в шину. Это позволит избавиться от пуллинга и реагировать на изменения в режиме реального времени. Но затраты
для на развертывание и поддержку
могут быть слишком большими. К тому же, в IT-отдел банка не обладает экспертизой в данном направлении, что тоже влечет
за собой дополнительные расходы.

Еще одним вариантом альтернативного решения является всё же оставить часть логики для работы с заявками в зоне
ответственности АБС, не создавая новые сервисы.
Но это влечет существенные риски в будущем, потому как уже сейчас АБС перегружена и дополнительная логика, которая
появится в рамках проекта может еще больше усугубить ситуацию.

**Недостатки, ограничения, риски**

Как и любое другое, данное решение несет определенные риски.
В рамках проекта появляются новые компоненты и новые технологии, в которых банк может не обладать достаточной
экспертизой.

С технической точки зрения, т.к. в рамках проекта появляется асинхронное взаимодействие, это может привести к состоянию
Eventually Consistent,
которое может быть неприемлемо в некоторых случаях для банка.

В свою очередь, появление дополнительных компонент, которые работают с разными категориями данных, может потребовать
внедрения и/или пересмотра существующей
политики по работе с данными и их защите.

При определенном уровне нагрузки к сервису `Rates Service` могут возникнуть задержки с ответом. В этом случае имеет смысл 
рассмотреть механизмы кэширования как на клиентской стороне, так и на серверной.