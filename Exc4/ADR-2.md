**Название задачи:** ADR-MVP-2 Банк Стандарт. Обмен ставками  
**Автор:** Аксёнов Иван    
**Дата:** 16.12.2024

**Функциональные требования**

| №   | Действующие лица или системы                 | Use Case                                | Описание                                                                                                                                                                                                                                                                                                                                                    |
|-----|----------------------------------------------|-----------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| UC1 | клиент, <br/>кол-центр <br/> сервис ставок   | Инфо о ставках в кол-центре             | 1. Оператор принимает звонок клиента.<br/>2. Клиент интересуется актуальными депозитами и ставками.<br/> 3. Оператор в своей системе открывает раздел с депозитами<br/>4. Система оператора делает запрос в сервис ставок<br/>5. После получения ответа, система предоставляет информацию о текущих депозитах и ставках<br/>6. Оператор информирует клиента |
| UC2 | сервис ставок, менеджер кредитного отдела    | Расссылка информации по ставкам         | 1. Менеджер кредитного отдела в начале операционного для обновляет ставки в сервисе ставок.<br/>2. Сервис ставок публикует новые ставки в шину<br/>3. Сервис ставок получает событие и формирует документ (отчет) с информацией по ставкам и депозитам.<br/> 4. Сервис ставок выкладывает подготовленный отчет через SFTP в сконфигурированную папку        |
| UC3 | клиент,<br/>оператор партнерского кол-центра | Инфо о ставках в партнерском кол-центре | 1. Оператор парт. кол-центра принимает звонок клиента.<br/> 2. Клиент интересуется актуальными депозитами и ставками.<br/>3. Оператор открывает документ (отчет) со ставка, находящийся на STFP.<br/> 4. Оператор информирует клиента по актуальынм услугам банка.                                                                                          |

**Нефункциональные требования**

| №   | Требование                                                                                                                       |
|-----|:---------------------------------------------------------------------------------------------------------------------------------|
| R1  | Все сервисы должны работать 24/7                                                                                                 |
| R2  | Уровень доступности платформы должен соотвествовать SLA 99.9%                                                                    |
| P2  | Отклик по всем операциям должен быть максимально быстрым и занимать миллисекунды                                                 |
| +R4 | Используем микросервисную архитектуру с развертыванием в Kubernetes для обеспечения более гибкой маштабируемости и развертывания |
| +R8 | Реализовать платформу на основе Event Driven похода, для будущих перспектив.                                                     |
| +R9 | Платформа должна удовлетворять всем требованиям местных регуляторов по защите, хранению и обработке персональной информации      |

**Решение**

```puml
@startuml
scale 0.85
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
SHOW_PERSON_OUTLINE()

title Банк Стандарт MVP Context Diagram
top to bottom direction
'skinparam linetype ortho
'skinparam linetype polyline

Person(client, "Клиент банка", "")

System_Ext(partnerCall, "Партнерский кол-центр", "Консультации клиентов по телефону")
System_Ext(sftp, "SFTP", "Хранилище файлов")

Boundary(system, "Банк Стандарт") {
    Boundary(backOffice, "Банк Стандарт бэк-офис") {
        System(bank, "IT банка", "Обеспечивает операционную деятельность банка. Включает не только АБС, но все IT компоненты")
        System(callCenter, "Кол-центр", "Обрабатывает входящие звонки")
        Person(backManager, "Менеджер бэк-офиса", "Обрабатывает заявки")
    }
}

client-down->callCenter: "Звонит в кол-центр"
client-down->partnerCall: "Звонит в кол-центр"
callCenter<--bank: "Запрашивает актуальные ставки"
partnerCall-->sftp: "Запрос отчета по ставкам"
backManager-->bank: "Рассчитывает новые ставки"
bank-->sftp: "Выгружает данные по ставкам"

@enduml
```

Итак, перед нами стоит две задачи в рамках этого ADR:

- Предоставить доступ сотрудникам банковского кол-центра к информации о ставках и депозитах.
- Предоставить доступ сотрудникам партнерского кол-центра к информации о ставках и депозитах.

В первом случае система кол-центра находится в банке и обслуживается сотрудниками IT-отдела банка, мы можем
доработать
систему, чтобы она могла обращаться к новому сервису `Rates Service`, получая актуальные ставки и информацию по
депозитам. После этого
оператор может озвучить клиенту эту информацию по телефону

Во втором случае партнерский кол-центр является внешней организацией по отношению к банку и соответственно не
имеет доступа
к внутренним системам банка. Поэтому мы будем формировать отчетный документ после обновления ставок и предоставлять его
кол-центру
путем выкладывания его на SFTP.

```puml
@startuml
scale 0.8
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

SHOW_PERSON_OUTLINE()

title Банк Стандарт MVP Container Diagram
top to bottom direction

'skinparam linetype ortho
'skinparam linetype polyline

'!pragma layout smetana

AddElementTag("mvp", $shape=RoundedBoxShape(), $bgColor="CornflowerBlue", $fontColor="white", $legendText="microservice")
AddElementTag("storage", $shape=RoundedBoxShape(), $bgColor="lightSkyBlue", $fontColor="white", $legendText="storage")
AddElementTag("queue", $shape=RoundedBoxShape(), $bgColor="#b6ccde", $fontColor="white", $legendText="event sourcing")
AddRelTag("async", $textColor=$ARROW_FONT_COLOR, $lineColor=$ARROW_COLOR, $lineStyle=DashedLine())

Person(client, "Клиент банка", "")

System_Ext(partnerCall, "Партнерский кол-центр", "Консультации клиентов по телефону")
System_Ext(sftp, "FTP", "Хранилище файлов")

Boundary(system, "Банк Стандарт") {
    
    Boundary(backOffice, "Банк Стандарт бэк-офис") {
        Container(abs, "АБС банка", "Delphi", "Клиент для операционной деятельности сотрудников банка" )
        
        Container(ratesService, "Сервис депозитов и ставок", "SpringBoot", "Формирует ставки по депозитам\nПросчитывает персональные ставки", $tags = "mvp")
        ContainerDb(ratesService_db, "База данных \nсервиса ставок", "PostgreSQL", "Данные по ставкам\nИнформацию для расчета ставок", $tags = "storage")
        ContainerQueue(kafka, "Kafka", "kafka", "Получает и публикует события", "Uses kafka protocol", $tags = "queue")
        Container(callCenter, "Кол-центр", "Обрабатывает входящие звонки")
    
        Person(backManager, "Менеджер бэк-офиса", "Поддерживает банковские операционные процессы.")
    }
    
}

Rel(client, callCenter, "Обслуживает клиента")
Rel_Neighbor(client, partnerCall, "Обслуживает клиента")
Rel(ratesService, abs, "Опрос данных для расчета ставок", "SQL")
Rel(ratesService, ratesService_db, "Сохраняет/читает данные", "SQL")
Rel(backManager, ratesService, "Обновляет ставки", "Http/Rest")
Rel(ratesService, kafka, "Публикует ставки депозитов", "kafka", $tags = "async")
Rel(ratesService, sftp, "Загружает отчет с информацией по ставкам и депозитам", "FTP")
Rel(partnerCall, sftp, "Скачивает отчет ставок", "FTP")
Rel(callCenter, ratesService, "Запрашивает ставки", "Http/Rest")


@enduml
```

**Альтернативы**

Альтернативой запроса ставок системой кол-центра является подписка события обновления на ставки (уже есть события), но
тогда их надо будет где-то хранить (кэшировать, сохранять в БД).  
Это имеет смысл при интенсивном обращении за информацией по ставкам.

Также альтернативой использования ftp как канала обмена файлами можно рассмотреть использование S3 хранилища.

**Недостатки, ограничения, риски**

В рамках данного ADR не рассматриваются вопросы безопасности и доступа системы кол-центра банка к данным в сервисе
ставок.
Любые запросы должны быть аутентифицированы и авторизованы. Реализация зависит от того, какой IAM инструмент и какие
походы (ACL, RBAC, ABAC)
используются в банке.

FTP несколько устаревший протокол, поэтому предпочтительнее рассмотреть другие варианты взаимодействия с внешним
кол-центром. 